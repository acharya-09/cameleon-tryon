<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cameleon - Il tuo Camerino Virtuale</title>
    
    <!-- Vercel Analytics -->
    <script defer src="/_vercel/insights/script.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #2e1a47 0%, #3d2454 50%, #4a2b5f 100%);
            min-height: 100vh;
            color: white;
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 100vw;
            margin: 0;
            padding: 10px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
            gap: 30px;
            padding: 20px 20px 0 20px; /* Add top padding to accommodate logo */
            position: relative;
            min-height: 120px; /* Ensure enough height for logo */
        }

        .logo {
            height: 120px;
            width: auto;
            filter: drop-shadow(0 12px 30px rgba(168, 85, 247, 0.8));
            position: absolute;
            left: 20px;
            top: 50%; /* Center vertically within header */
            transform: translateY(-50%); /* Perfect vertical centering */
        }

        .title {
            font-size: 48px;
            font-weight: 700;
            color: white;
            text-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
            margin: 0;
            text-align: center;
            flex: 1;
        }

        .content-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 40px;
            margin-bottom: 15px;
            flex: 1;
            width: 100%;
            padding: 0 10px;
        }

        .upload-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .section-title {
            font-size: 36px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
            color: white;
            text-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        .image-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            height: 500px;
            width: 100%;
            max-width: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            border: 3px dashed rgba(255, 255, 255, 0.4);
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            aspect-ratio: 1;
        }

        .image-container.generating {
            border: 3px solid rgba(168, 85, 247, 0.8);
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.6), 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {
            0%, 100% { 
                box-shadow: 0 0 30px rgba(168, 85, 247, 0.6), 0 10px 30px rgba(0, 0, 0, 0.3);
                border-color: rgba(168, 85, 247, 0.8);
            }
            50% { 
                box-shadow: 0 0 50px rgba(168, 85, 247, 0.9), 0 10px 30px rgba(0, 0, 0, 0.3);
                border-color: rgba(168, 85, 247, 1);
            }
        }

        .image-container:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .image-container.has-image {
            border: 2px solid rgba(168, 85, 247, 0.5);
        }

        .image-container.drag-over {
            background: rgba(168, 85, 247, 0.15);
            border: 2px solid rgba(168, 85, 247, 0.8);
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(168, 85, 247, 0.4);
        }

        .image-container.drag-over .upload-placeholder {
            opacity: 0.9;
        }

        .image-container.drag-over .upload-icon {
            animation: bounce 0.6s ease-in-out infinite alternate;
        }

        @keyframes bounce {
            0% { transform: translateY(0); }
            100% { transform: translateY(-5px); }
        }

        .preview-image, .result-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            border-radius: 18px;
        }

        .upload-placeholder {
            text-align: center;
            padding: 30px;
        }

        .upload-icon {
            font-size: 50px;
            margin-bottom: 15px;
            opacity: 0.7;
        }

        .upload-text {
            font-size: 16px;
            opacity: 0.8;
            line-height: 1.4;
        }

        .arrow-container {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            color: rgba(255, 255, 255, 0.9);
            padding: 0 20px;
            flex: 0 0 auto;
            height: 500px; /* Match the image container height */
        }

        .arrow {
            animation: slideArrow 2s ease-in-out infinite;
        }

        @keyframes slideArrow {
            0%, 100% { transform: translateX(0); opacity: 0.8; }
            50% { transform: translateX(10px); opacity: 1; }
        }

        .result-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .result-container {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            height: 550px;
            width: 100%;
            max-width: 550px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            aspect-ratio: 1;
        }

        .result-container.generating {
            border: 3px solid rgba(52, 211, 153, 0.8);
            box-shadow: 0 0 40px rgba(52, 211, 153, 0.6), 0 15px 40px rgba(0, 0, 0, 0.4);
            animation: resultGlow 2.5s ease-in-out infinite;
        }

        @keyframes resultGlow {
            0%, 100% { 
                box-shadow: 0 0 40px rgba(52, 211, 153, 0.6), 0 15px 40px rgba(0, 0, 0, 0.4);
                border-color: rgba(52, 211, 153, 0.8);
            }
            50% { 
                box-shadow: 0 0 60px rgba(52, 211, 153, 0.9), 0 15px 40px rgba(0, 0, 0, 0.4);
                border-color: rgba(52, 211, 153, 1);
            }
        }

        .result-container.has-result {
            border-color: rgba(52, 211, 153, 0.6);
        }

        .result-placeholder {
            text-align: center;
            opacity: 0.7;
            padding: 30px;
        }

        .result-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .result-placeholder div {
            font-size: 16px;
        }

        .animated-logo {
            position: absolute;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%);
            height: 120px;
            width: auto;
            opacity: 0;
            z-index: 10;
        }

        .animated-logo.show {
            animation: logoFade 2s ease-in-out infinite;
        }

        @keyframes logoFade {
            0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8) rotate(0deg); }
            50% { opacity: 0.9; transform: translate(-50%, -50%) scale(1.2) rotate(5deg); }
        }

        .result-actions {
            position: absolute;
            bottom: 15px;
            right: 15px;
            display: none;
            gap: 10px;
        }

        .result-container.has-result .result-actions {
            display: flex;
        }

        .action-btn {
            background: rgba(168, 85, 247, 0.9);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            background: rgba(168, 85, 247, 1);
            transform: scale(1.1);
        }

        .generate-button {
            background: linear-gradient(90deg, #6366f1 0%, #a855f7 50%, #ec4899 100%);
            color: white;
            border: none;
            padding: 24px 80px;
            font-size: 28px;
            border-radius: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 25px auto;
            transition: all 0.3s ease;
            font-weight: 700;
            letter-spacing: 1px;
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.6), 0 15px 40px rgba(168, 85, 247, 0.3);
            min-width: 250px;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .generate-button::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(90deg, #6366f1, #a855f7, #ec4899, #6366f1);
            border-radius: 52px;
            z-index: -1;
            animation: rotateGlow 3s linear infinite;
            opacity: 0.8;
        }

        @keyframes rotateGlow {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .generate-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 40px rgba(168, 85, 247, 0.8), 0 20px 50px rgba(168, 85, 247, 0.4);
        }

        .generate-button.loading {
            animation: buttonPulse 1.5s ease-in-out infinite;
        }

        @keyframes buttonPulse {
            0%, 100% { 
                box-shadow: 0 0 30px rgba(168, 85, 247, 0.6), 0 15px 40px rgba(168, 85, 247, 0.3);
            }
            50% { 
                box-shadow: 0 0 50px rgba(168, 85, 247, 0.9), 0 15px 40px rgba(168, 85, 247, 0.5);
            }
        }

        .generate-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .generate-button.loading {
            background: linear-gradient(90deg, #6366f1 0%, #a855f7 50%, #ec4899 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        input[type="file"] {
            display: none;
        }

        .remove-image {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .remove-image:hover {
            background: rgba(239, 68, 68, 1);
            transform: scale(1.1);
        }

        .image-container.has-image .remove-image {
            display: flex;
        }

        .success-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(52, 211, 153, 0.9);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: none;
        }

        .error-message {
            color: #ff6b6b;
            text-align: center;
            padding: 10px;
            margin-top: 10px;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 10px;
            display: none;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            max-width: 800px;
            margin: 50px auto;
            display: none;
        }

        .progress-container.show {
            display: block;
        }

        .progress-bar-wrapper {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            height: 12px;
            overflow: hidden;
            margin-bottom: 25px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #a855f7, #ec4899);
            border-radius: 30px;
            width: 0%;
            transition: width 0.5s ease;
        }

        .progress-text {
            text-align: center;
            font-size: 24px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .progress-subtext {
            text-align: center;
            font-size: 18px;
            opacity: 0.8;
        }

        .progress-timer {
            text-align: center;
            font-size: 16px;
            opacity: 0.6;
            margin-top: 15px;
        }

        /* Swap Type Selector - Updated with all new options */
        .swap-type-section {
            width: 100%;
            margin: 20px auto 20px auto;
            text-align: center;
            padding: 0 10px;
        }

        .swap-type-title {
            font-size: 36px;
            font-weight: 600;
            color: white;
            margin-bottom: 20px;
            text-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        .swap-type-options {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            flex-wrap: nowrap;
            padding: 0;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }

        .swap-type-option {
            cursor: pointer;
            display: block;
            flex: 1;
            min-width: 0;
        }

        .swap-type-option input[type="radio"] {
            display: none;
        }

        .swap-type-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 16px;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 18px;
            transition: all 0.3s ease;
            height: 110px;
            justify-content: center;
            white-space: nowrap;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }

        .swap-type-option:hover .swap-type-label {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(168, 85, 247, 0.4);
            transform: translateY(-2px);
        }

        .swap-type-option input[type="radio"]:checked + .swap-type-label {
            background: rgba(168, 85, 247, 0.2);
            border-color: rgba(168, 85, 247, 0.6);
            box-shadow: 0 6px 20px rgba(168, 85, 247, 0.3);
        }

        .swap-type-icon {
            font-size: 32px;
            margin-bottom: 8px;
            display: block;
        }

        .swap-type-text {
            font-size: 18px;
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
            display: block;
        }

        .swap-type-desc {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.2;
            display: block;
            text-overflow: ellipsis;
            overflow: hidden;
        }

        /* Modal for enlarged image */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
        }

        .modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            margin-top: 5%;
            border-radius: 10px;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-close:hover {
            color: #a855f7;
        }

        @media (max-width: 1024px) {
            .header {
                flex-direction: column;
                align-items: center;
                text-align: center;
                gap: 15px;
                padding: 0 10px;
            }

            .title {
                text-align: center;
            }

            .content-wrapper {
                flex-direction: column;
                align-items: center;
                gap: 30px;
                padding: 0 5px;
            }
            
            .arrow-container {
                transform: rotate(90deg);
                padding: 15px 0;
                height: auto;
                font-size: 60px;
            }
            
            .title {
                font-size: 40px;
            }
            
            .logo {
                height: 100px;
            }

            .section-title {
                font-size: 28px;
            }

            .image-container {
                height: 400px;
                max-width: 400px;
            }

            .result-container {
                height: 450px;
                max-width: 450px;
            }

            .swap-type-options {
                gap: 10px;
            }

            .swap-type-option {
                min-width: 120px;
            }

            .swap-type-label {
                height: 100px;
                padding: 18px 12px;
            }

            .swap-type-icon {
                font-size: 30px;
            }

            .swap-type-text {
                font-size: 17px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 8px;
            }
            
            .header {
                margin-bottom: 15px;
                flex-direction: column;
                text-align: center;
            }
            
            .title {
                font-size: 32px;
                text-align: center;
            }
            
            .logo {
                height: 80px;
            }
            
            .section-title {
                font-size: 24px;
                margin-bottom: 12px;
            }
            
            .image-container {
                height: 350px;
                max-width: 350px;
            }

            .result-container {
                height: 380px;
                max-width: 380px;
            }
            
            .generate-button {
                padding: 18px 40px;
                font-size: 22px;
                margin: 20px auto;
            }

            .swap-type-section {
                margin: 15px auto 15px auto;
            }

            .swap-type-title {
                font-size: 26px;
                margin-bottom: 15px;
            }

            .swap-type-options {
                gap: 8px;
            }

            .swap-type-option {
                min-width: 100px;
            }

            .swap-type-label {
                padding: 14px 8px;
                height: 90px;
            }

            .swap-type-icon {
                font-size: 26px;
                margin-bottom: 4px;
            }

            .swap-type-text {
                font-size: 15px;
                margin-bottom: 3px;
            }

            .swap-type-desc {
                font-size: 10px;
            }
        }

        @media (max-width: 480px) {
            .title {
                font-size: 28px;
            }
            
            .logo {
                height: 70px;
            }
            
            .section-title {
                font-size: 18px;
            }
            
            .image-container,
            .result-container {
                height: 250px;
                max-width: 220px;
            }
            
            .upload-icon, .result-icon {
                font-size: 40px;
            }
            
            .upload-text, .result-placeholder div {
                font-size: 14px;
            }
            
            .generate-button {
                padding: 12px 25px;
                font-size: 14px;
            }
            
            .arrow-container {
                font-size: 40px;
            }

            .swap-type-section {
                margin: 15px auto 15px auto;
            }

            .swap-type-title {
                font-size: 16px;
                margin-bottom: 10px;
            }

            .swap-type-options {
                gap: 4px;
                padding: 2px;
            }

            .swap-type-option {
                min-width: 75px;
            }

            .swap-type-label {
                padding: 6px 4px;
                height: 55px;
            }

            .swap-type-icon {
                font-size: 14px;
                margin-bottom: 2px;
            }

            .swap-type-text {
                font-size: 10px;
                margin-bottom: 1px;
            }

            .swap-type-desc {
                font-size: 7px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="Logo.png" alt="Cameleon Logo" class="logo">
            <h1 class="title">Il tuo Camerino Virtuale</h1>
        </div>
        
        <div class="content-wrapper">
            <!-- Upload della foto personale -->
            <div class="upload-section">
                <h2 class="section-title">Modella</h2>
                <div class="image-container" id="userImageContainer" onclick="document.getElementById('userImage').click()">
                    <input type="file" id="userImage" accept="image/*" onchange="handleImageUpload('userImage', 'userImageContainer')">
                    <div class="upload-placeholder" id="userPlaceholder">
                        <div class="upload-icon">üì∑</div>
                        <div class="upload-text">Clicca per caricare la modella<br><small style="opacity: 0.7;">Massimo 4MB - Compressione automatica</small></div>
                    </div>
                    <button class="remove-image" onclick="removeImage(event, 'userImageContainer', 'userPlaceholder')">√ó</button>
                </div>
            </div>
            
            <!-- Upload del vestito -->
            <div class="upload-section">
                <h2 class="section-title">Prodotto</h2>
                <div class="image-container" id="clothingImageContainer" onclick="document.getElementById('clothingImage').click()">
                    <input type="file" id="clothingImage" accept="image/*" onchange="handleImageUpload('clothingImage', 'clothingImageContainer')">
                    <div class="upload-placeholder" id="clothingPlaceholder">
                        <div class="upload-icon">üëó</div>
                        <div class="upload-text">Clicca per caricare il prodotto<br><small style="opacity: 0.7;">Massimo 4MB - Compressione automatica</small></div>
                    </div>
                    <button class="remove-image" onclick="removeImage(event, 'clothingImageContainer', 'clothingPlaceholder')">√ó</button>
                </div>
            </div>
            
            <!-- Freccia -->
            <div class="arrow-container">
                <span class="arrow">‚û§</span>
            </div>
            
            <!-- Risultato -->
            <div class="result-section">
                <h2 class="section-title">Risultato</h2>
                <div class="result-container" id="resultContainer">
                    <div class="result-placeholder" id="resultPlaceholder">
                        <div class="result-icon">‚ú®</div>
                        <div>Il tuo outfit virtuale apparir√† qui</div>
                    </div>
                    <img src="Logo.png" alt="Cameleon" class="animated-logo" id="animatedLogo">
                    <span class="success-badge" id="successBadge">‚úì Generato</span>
                    <div class="result-actions">
                        <button class="action-btn" onclick="downloadImage()" title="Scarica immagine">üíæ</button>
                        <button class="action-btn" onclick="enlargeImage()" title="Ingrandisci">üîç</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Progress Bar -->
        <!-- Swap Type Selector - Updated with all new categories -->
        <div class="swap-type-section">
            <h3 class="swap-type-title">Tipo di Prova</h3>
            <div class="swap-type-options">
                <label class="swap-type-option">
                    <input type="radio" name="swapType" value="Full Outfit" checked>
                    <span class="swap-type-label">
                        <span class="swap-type-icon">üëî</span>
                        <span class="swap-type-text">Completo</span>
                        <span class="swap-type-desc">Outfit intero</span>
                    </span>
                </label>
                <label class="swap-type-option">
                    <input type="radio" name="swapType" value="Upper-Body">
                    <span class="swap-type-label">
                        <span class="swap-type-icon">üëï</span>
                        <span class="swap-type-text">Sopra</span>
                        <span class="swap-type-desc">Maglie, camicie</span>
                    </span>
                </label>
                <label class="swap-type-option">
                    <input type="radio" name="swapType" value="Lower-Body">
                    <span class="swap-type-label">
                        <span class="swap-type-icon">üëñ</span>
                        <span class="swap-type-text">Sotto</span>
                        <span class="swap-type-desc">Pantaloni, gonne</span>
                    </span>
                </label>
                <label class="swap-type-option">
                    <input type="radio" name="swapType" value="Dress">
                    <span class="swap-type-label">
                        <span class="swap-type-icon">üëó</span>
                        <span class="swap-type-text">Vestito</span>
                        <span class="swap-type-desc">Abiti, vestiti</span>
                    </span>
                </label>
                <label class="swap-type-option">
                    <input type="radio" name="swapType" value="Shoes">
                    <span class="swap-type-label">
                        <span class="swap-type-icon">üë†</span>
                        <span class="swap-type-text">Scarpe</span>
                        <span class="swap-type-desc">Calzature</span>
                    </span>
                </label>
                <label class="swap-type-option">
                    <input type="radio" name="swapType" value="Headwear">
                    <span class="swap-type-label">
                        <span class="swap-type-icon">üé©</span>
                        <span class="swap-type-text">Cappelli</span>
                        <span class="swap-type-desc">Copricapo</span>
                    </span>
                </label>
                <label class="swap-type-option">
                    <input type="radio" name="swapType" value="Eyewear">
                    <span class="swap-type-label">
                        <span class="swap-type-icon">üï∂Ô∏è</span>
                        <span class="swap-type-text">Occhiali</span>
                        <span class="swap-type-desc">Da sole, vista</span>
                    </span>
                </label>
                <label class="swap-type-option">
                    <input type="radio" name="swapType" value="Bodywear">
                    <span class="swap-type-label">
                        <span class="swap-type-icon">üß£</span>
                        <span class="swap-type-text">Accessori</span>
                        <span class="swap-type-desc">Sciarpe, cravatte</span>
                    </span>
                </label>
                <label class="swap-type-option">
                    <input type="radio" name="swapType" value="Jewelry">
                    <span class="swap-type-label">
                        <span class="swap-type-icon">üíé</span>
                        <span class="swap-type-text">Gioielli</span>
                        <span class="swap-type-desc">Collane, anelli</span>
                    </span>
                </label>
                <label class="swap-type-option">
                    <input type="radio" name="swapType" value="Bags">
                    <span class="swap-type-label">
                        <span class="swap-type-icon">üëú</span>
                        <span class="swap-type-text">Borse</span>
                        <span class="swap-type-desc">Zaini, borsette</span>
                    </span>
                </label>
            </div>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-text" id="progressText">Caricamento immagini...</div>
            <div class="progress-bar-wrapper">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-subtext" id="progressSubtext">Preparazione in corso...</div>
            <div class="progress-timer" id="progressTimer">Tempo trascorso: 0s</div>
        </div>
        
        <button class="generate-button" id="generateButton" onclick="generateImage()" disabled>
            <span>‚≠ê</span>
            <span>Genera</span>
        </button>
        
        <div class="error-message" id="errorMessage"></div>
    </div>

    <!-- Modal for enlarged image -->
    <div id="imageModal" class="modal">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <script>
        let userImageFile = null;
        let clothingImageFile = null;
        let currentGeneratedImageUrl = null;

        // Get selected swap type
        function getSelectedSwapType() {
            const selectedRadio = document.querySelector('input[name="swapType"]:checked');
            return selectedRadio ? selectedRadio.value : 'Full Outfit';
        }

        // Drag and Drop functionality
        function setupDragAndDrop() {
            const userContainer = document.getElementById('userImageContainer');
            const clothingContainer = document.getElementById('clothingImageContainer');

            // Setup drag and drop for user image container
            setupContainerDragDrop(userContainer, 'userImage');
            
            // Setup drag and drop for clothing image container
            setupContainerDragDrop(clothingContainer, 'clothingImage');
        }

        function setupContainerDragDrop(container, inputId) {
            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                container.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            // Highlight drop area when item is dragged over it
            ['dragenter', 'dragover'].forEach(eventName => {
                container.addEventListener(eventName, () => highlightDropArea(container), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                container.addEventListener(eventName, () => unhighlightDropArea(container), false);
            });

            // Handle dropped files
            container.addEventListener('drop', (e) => handleDrop(e, inputId), false);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlightDropArea(container) {
            container.classList.add('drag-over');
        }

        function unhighlightDropArea(container) {
            container.classList.remove('drag-over');
        }

        function handleDrop(e, inputId) {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length > 0) {
                const file = files[0];
                
                // Check if it's an image file
                if (file.type.startsWith('image/')) {
                    // Create a file input event simulation
                    const input = document.getElementById(inputId);
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    input.files = dataTransfer.files;
                    
                    // Get container ID from input ID
                    const containerId = inputId === 'userImage' ? 'userImageContainer' : 'clothingImageContainer';
                    
                    // Process the uploaded file
                    handleImageUpload(inputId, containerId);
                } else {
                    showError('Per favore carica solo file immagine (JPG, PNG, etc.)');
                }
            }
        }

        // Dynamic progress stages based on swap type
        function getProgressStages(swapType) {
            const baseStages = [
                { text: "Caricamento immagini...", subtext: "Upload delle immagini al server", progress: 15 },
                { text: "Avvio generazione AI...", subtext: "Inizializzazione Gemini Nano Banana", progress: 25 }
            ];

            const swapTypeStages = {
                'Full Outfit': [
                    { text: "Analisi modella...", subtext: "Riconoscimento pose e caratteristiche", progress: 40 },
                    { text: "Analisi outfit completo...", subtext: "Estrazione stile e pattern", progress: 55 },
                    { text: "Rendering outfit...", subtext: "Applicazione completo sulla modella", progress: 70 },
                    { text: "Fusione realistica...", subtext: "Adattamento perfetto al corpo", progress: 85 },
                    { text: "Ottimizzazione finale...", subtext: "Perfezionamento outfit completo", progress: 95 }
                ],
                'Upper-Body': [
                    { text: "Analisi modella...", subtext: "Riconoscimento pose e busto", progress: 40 },
                    { text: "Analisi capo superiore...", subtext: "Estrazione pattern e taglio", progress: 55 },
                    { text: "Rendering capo...", subtext: "Applicazione su parte superiore", progress: 70 },
                    { text: "Adattamento corporeo...", subtext: "Fusione naturale con busto", progress: 85 },
                    { text: "Rifinitura dettagli...", subtext: "Perfezionamento capo superiore", progress: 95 }
                ],
                'Lower-Body': [
                    { text: "Analisi modella...", subtext: "Riconoscimento pose e gambe", progress: 40 },
                    { text: "Analisi capo inferiore...", subtext: "Estrazione forma e stile", progress: 55 },
                    { text: "Rendering capo...", subtext: "Applicazione su parte inferiore", progress: 70 },
                    { text: "Adattamento gambe...", subtext: "Fusione naturale con corpo", progress: 85 },
                    { text: "Rifinitura dettagli...", subtext: "Perfezionamento capo inferiore", progress: 95 }
                ],
                'Dress': [
                    { text: "Analisi modella...", subtext: "Riconoscimento pose e figura", progress: 40 },
                    { text: "Analisi vestito...", subtext: "Estrazione stile e vestibilit√†", progress: 55 },
                    { text: "Rendering vestito...", subtext: "Applicazione abito completo", progress: 70 },
                    { text: "Drappeggio tessuto...", subtext: "Simulazione caduta naturale", progress: 85 },
                    { text: "Rifinitura elegante...", subtext: "Perfezionamento vestito", progress: 95 }
                ],
                'Shoes': [
                    { text: "Analisi modella...", subtext: "Riconoscimento piedi e postura", progress: 40 },
                    { text: "Analisi calzature...", subtext: "Estrazione forma e stile", progress: 55 },
                    { text: "Rendering scarpe...", subtext: "Applicazione calzature", progress: 70 },
                    { text: "Adattamento piedi...", subtext: "Fusione naturale con piedi", progress: 85 },
                    { text: "Rifinitura scarpe...", subtext: "Perfezionamento calzature", progress: 95 }
                ],
                'Headwear': [
                    { text: "Analisi modella...", subtext: "Riconoscimento testa e capelli", progress: 40 },
                    { text: "Analisi cappello...", subtext: "Estrazione forma e dimensioni", progress: 55 },
                    { text: "Rendering copricapo...", subtext: "Applicazione su testa", progress: 70 },
                    { text: "Adattamento cranio...", subtext: "Fusione naturale con testa", progress: 85 },
                    { text: "Rifinitura cappello...", subtext: "Perfezionamento copricapo", progress: 95 }
                ],
                'Eyewear': [
                    { text: "Analisi modella...", subtext: "Riconoscimento viso e occhi", progress: 40 },
                    { text: "Analisi occhiali...", subtext: "Estrazione forma e montatura", progress: 55 },
                    { text: "Rendering occhiali...", subtext: "Applicazione su viso", progress: 70 },
                    { text: "Adattamento viso...", subtext: "Fusione naturale con naso", progress: 85 },
                    { text: "Rifinitura occhiali...", subtext: "Perfezionamento montatura", progress: 95 }
                ],
                'Bodywear': [
                    { text: "Analisi modella...", subtext: "Riconoscimento collo e spalle", progress: 40 },
                    { text: "Analisi accessorio...", subtext: "Estrazione forma e tessuto", progress: 55 },
                    { text: "Rendering accessorio...", subtext: "Applicazione su corpo", progress: 70 },
                    { text: "Drappeggio naturale...", subtext: "Simulazione caduta tessuto", progress: 85 },
                    { text: "Rifinitura accessorio...", subtext: "Perfezionamento dettagli", progress: 95 }
                ],
                'Jewelry': [
                    { text: "Analisi modella...", subtext: "Riconoscimento collo e mani", progress: 40 },
                    { text: "Analisi gioielli...", subtext: "Estrazione materiali e forma", progress: 55 },
                    { text: "Rendering gioielli...", subtext: "Applicazione ornamenti", progress: 70 },
                    { text: "Riflessi metallici...", subtext: "Simulazione luci e brillantezza", progress: 85 },
                    { text: "Rifinitura gioielli...", subtext: "Perfezionamento ornamenti", progress: 95 }
                ],
                'Bags': [
                    { text: "Analisi modella...", subtext: "Riconoscimento spalle e mani", progress: 40 },
                    { text: "Analisi borsa...", subtext: "Estrazione forma e materiali", progress: 55 },
                    { text: "Rendering borsa...", subtext: "Applicazione accessorio", progress: 70 },
                    { text: "Posizionamento naturale...", subtext: "Adattamento a pose e corpo", progress: 85 },
                    { text: "Rifinitura borsa...", subtext: "Perfezionamento accessorio", progress: 95 }
                ]
            };

            return [...baseStages, ...(swapTypeStages[swapType] || swapTypeStages['Full Outfit'])];
        }

        // Image compression utility (quality compression only, no resizing)
        function compressImage(file, maxSizeMB = 3.5, quality = 0.8) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Keep original dimensions - no resizing
                    const { width, height } = img;
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw image at original size and compress
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    canvas.toBlob((blob) => {
                        // Check if compression was effective
                        const maxBytes = maxSizeMB * 1024 * 1024;
                        
                        if (blob.size > maxBytes && quality > 0.1) {
                            // Try with lower quality
                            const newQuality = Math.max(0.1, quality - 0.1);
                            compressImage(file, maxSizeMB, newQuality).then(resolve);
                        } else {
                            // Create new file with compressed data
                            const compressedFile = new File([blob], file.name, {
                                type: 'image/jpeg',
                                lastModified: Date.now()
                            });
                            resolve(compressedFile);
                        }
                    }, 'image/jpeg', quality);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        async function handleImageUpload(inputId, containerId) {
            const input = document.getElementById(inputId);
            const container = document.getElementById(containerId);
            const file = input.files[0];
            
            if (file) {
                // Show compression status
                const placeholder = container.querySelector('.upload-placeholder');
                if (placeholder) {
                    placeholder.innerHTML = `
                        <div class="upload-icon">‚è≥</div>
                        <div class="upload-text">Ottimizzazione immagine...</div>
                    `;
                }
                
                try {
                    // Check file size and compress if needed
                    const originalSize = file.size;
                    let processedFile = file;
                    
                    if (originalSize > 3.5 * 1024 * 1024) { // If larger than 3.5MB
                        console.log(`Compressing ${file.name}: ${(originalSize / 1024 / 1024).toFixed(2)}MB`);
                        processedFile = await compressImage(file);
                        const compressedSize = processedFile.size;
                        console.log(`Compressed to: ${(compressedSize / 1024 / 1024).toFixed(2)}MB`);
                        
                        // Show compression info
                        if (window.va) {
                            window.va('track', 'Image Compressed', {
                                originalSize: originalSize,
                                compressedSize: compressedSize,
                                compressionRatio: (compressedSize / originalSize).toFixed(2)
                            });
                        }
                    }
                    
                    // Track image upload event
                    if (window.va) {
                        window.va('track', 'Image Upload', { 
                            type: inputId === 'userImage' ? 'User Image' : 'Clothing Image',
                            originalSize: originalSize,
                            finalSize: processedFile.size,
                            fileType: processedFile.type
                        });
                    }
                    
                    // Store the processed file
                    if (inputId === 'userImage') {
                        userImageFile = processedFile;
                    } else {
                        clothingImageFile = processedFile;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // Remove placeholder and add image
                        if (placeholder) {
                            placeholder.style.display = 'none';
                        }
                        
                        // Remove existing image if any
                        const existingImage = container.querySelector('.preview-image');
                        if (existingImage) {
                            existingImage.remove();
                        }
                        
                        // Add new image
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'preview-image';
                        container.appendChild(img);
                        container.classList.add('has-image');
                        
                        // Show file size info
                        const sizeText = document.createElement('div');
                        sizeText.style.cssText = `
                            position: absolute;
                            bottom: 5px;
                            left: 5px;
                            background: rgba(0,0,0,0.7);
                            color: white;
                            padding: 2px 6px;
                            border-radius: 4px;
                            font-size: 10px;
                            z-index: 5;
                        `;
                        sizeText.textContent = `${(processedFile.size / 1024 / 1024).toFixed(1)}MB`;
                        container.appendChild(sizeText);
                        
                        // Check if both images are uploaded
                        checkIfReadyToGenerate();
                    };
                    reader.readAsDataURL(processedFile);
                    
                } catch (error) {
                    console.error('Error processing image:', error);
                    showError('Errore nell\'elaborazione dell\'immagine. Riprova.');
                    
                    // Reset placeholder
                    if (placeholder) {
                        placeholder.innerHTML = `
                            <div class="upload-icon">${inputId === 'userImage' ? 'üì∑' : 'üëó'}</div>
                            <div class="upload-text">Clicca per caricare ${inputId === 'userImage' ? 'la modella' : 'il prodotto'}<br><small style="opacity: 0.7;">Massimo 4MB - Compressione automatica</small></div>
                        `;
                    }
                }
            }
        }

        function removeImage(event, containerId, placeholderId) {
            event.stopPropagation();
            const container = document.getElementById(containerId);
            const placeholder = document.getElementById(placeholderId);
            
            // Remove the image
            const image = container.querySelector('.preview-image');
            if (image) {
                image.remove();
            }
            
            // Show placeholder again
            placeholder.style.display = 'block';
            container.classList.remove('has-image');
            
            // Clear the file input
            if (containerId === 'userImageContainer') {
                document.getElementById('userImage').value = '';
                userImageFile = null;
            } else {
                document.getElementById('clothingImage').value = '';
                clothingImageFile = null;
            }
            
            checkIfReadyToGenerate();
        }

        function checkIfReadyToGenerate() {
            const generateButton = document.getElementById('generateButton');
            if (userImageFile && clothingImageFile) {
                generateButton.disabled = false;
            } else {
                generateButton.disabled = true;
            }
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        function updateProgress(stage, elapsed) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressSubtext = document.getElementById('progressSubtext');
            const progressTimer = document.getElementById('progressTimer');
            
            progressBar.style.width = stage.progress + '%';
            progressText.textContent = stage.text;
            progressSubtext.textContent = stage.subtext;
            progressTimer.textContent = `Tempo trascorso: ${Math.floor(elapsed / 1000)}s`;
        }

        async function runProgressStages(apiPromise, swapType) {
            const startTime = Date.now();
            let currentStageIndex = 0;
            let isCompleted = false;
            const progressStages = getProgressStages(swapType);
            
            // Function to cycle through progress stages
            function nextStage() {
                if (isCompleted) return;
                
                const elapsed = Date.now() - startTime;
                
                // If we've gone through all stages, stay at the last one
                if (currentStageIndex >= progressStages.length) {
                    const lastStage = progressStages[progressStages.length - 1];
                    updateProgress(lastStage, elapsed);
                    
                    // Keep cycling through the last few stages
                    currentStageIndex = Math.max(0, progressStages.length - 3);
                    setTimeout(nextStage, 8000); // Wait 8 seconds before cycling
                    return;
                }
                
                const stage = progressStages[currentStageIndex];
                updateProgress(stage, elapsed);
                
                currentStageIndex++;
                
                // Variable timing optimized for ~18s total generation
                let nextDelay = 3000; // Default 3 seconds (faster overall)
                if (currentStageIndex <= 2) nextDelay = 2000; // Very fast start
                if (currentStageIndex >= 4) nextDelay = 4000; // Moderate later stages
                
                setTimeout(nextStage, nextDelay);
            }
            
            // Start the progress animation
            nextStage();
            
            // Wait for the actual API response
            try {
                const result = await apiPromise;
                isCompleted = true;
                
                // Show completion stage with swap type specific message
                const elapsed = Date.now() - startTime;
                const completionMessages = {
                    'Shoes': 'Le tue scarpe sono pronte!',
                    'Headwear': 'Il tuo cappello √® perfetto!',
                    'Eyewear': 'I tuoi occhiali sono pronti!',
                    'Jewelry': 'I tuoi gioielli brillano!',
                    'Bags': 'La tua borsa √® pronta!',
                    'Upper-Body': 'Il tuo capo √® perfetto!',
                    'Lower-Body': 'Il tuo capo √® pronto!',
                    'Dress': 'Il tuo vestito √® elegante!',
                    'Bodywear': 'Il tuo accessorio √® perfetto!'
                };
                
                updateProgress({
                    text: "Completato!",
                    subtext: completionMessages[swapType] || "Il tuo nuovo look √® pronto!",
                    progress: 100
                }, elapsed);
                
                return result;
            } catch (error) {
                isCompleted = true;
                throw error;
            }
        }

        async function generateImage() {
            if (!userImageFile || !clothingImageFile) {
                showError('Per favore carica entrambe le immagini');
                return;
            }
            
            // Track generation start
            const selectedSwapType = getSelectedSwapType();
            if (window.va) {
                window.va('track', 'Generation Started', {
                    userImageSize: userImageFile.size,
                    clothingImageSize: clothingImageFile.size,
                    userImageType: userImageFile.type,
                    clothingImageType: clothingImageFile.type,
                    swapType: selectedSwapType
                });
            }
            
            const generateButton = document.getElementById('generateButton');
            const resultContainer = document.getElementById('resultContainer');
            const resultPlaceholder = document.getElementById('resultPlaceholder');
            const successBadge = document.getElementById('successBadge');
            const animatedLogo = document.getElementById('animatedLogo');
            const progressContainer = document.getElementById('progressContainer');
            
            // Clean up any previous state
            const existingResult = resultContainer.querySelector('.result-image');
            if (existingResult) {
                existingResult.remove();
            }
            successBadge.style.display = 'none';
            resultContainer.classList.remove('has-result');
            
            // Reset placeholder
            resultPlaceholder.style.display = 'flex';
            resultPlaceholder.innerHTML = `
                <div class="result-icon">‚ú®</div>
                <div>Il tuo outfit virtuale apparir√† qui</div>
            `;
            
            // Show loading state
            generateButton.disabled = true;
            generateButton.classList.add('loading');
            generateButton.innerHTML = '<span>‚è≥</span><span>Generazione in corso...</span>';
            
            // Add glowing effects to containers
            document.getElementById('userImageContainer').classList.add('generating');
            document.getElementById('clothingImageContainer').classList.add('generating');
            resultContainer.classList.add('generating');
            
            // Show progress bar and animated logo
            progressContainer.classList.add('show');
            animatedLogo.classList.add('show');
            
            // Prepare form data
            const formData = new FormData();
            formData.append('userImage', userImageFile);
            formData.append('clothingImage', clothingImageFile);
            formData.append('swapType', getSelectedSwapType());
            
            const startTime = Date.now();
            
            try {
                // Create the API promise
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 320000);
                
                const apiPromise = fetch('/api/generate', {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                }).then(response => {
                    clearTimeout(timeoutId);
                    return response.json().then(data => ({ response, data }));
                });
                
                // Run progress stages while waiting for API
                const { response, data } = await runProgressStages(apiPromise, selectedSwapType);
                
                if (response.ok && data.success && data.imageUrl) {
                    // Track successful generation
                    if (window.va) {
                        window.va('track', 'Generation Completed', {
                            success: true,
                            processingTime: Date.now() - startTime
                        });
                    }
                    
                    // Hide placeholder and progress, remove glowing effects
                    resultPlaceholder.style.display = 'none';
                    progressContainer.classList.remove('show');
                    animatedLogo.classList.remove('show');
                    
                    // Remove glowing effects
                    document.getElementById('userImageContainer').classList.remove('generating');
                    document.getElementById('clothingImageContainer').classList.remove('generating');
                    resultContainer.classList.remove('generating');
                    
                    // Store the image URL
                    currentGeneratedImageUrl = data.imageUrl;
                    
                    // Display the result image
                    const resultImage = document.createElement('img');
                    resultImage.src = data.imageUrl;
                    resultImage.className = 'result-image';
                    resultImage.onload = () => {
                        successBadge.style.display = 'block';
                        resultContainer.classList.add('has-result');
                    };
                    resultContainer.appendChild(resultImage);
                    
                } else {
                    throw new Error(data.message || 'Errore nella generazione dell\'immagine');
                }
                
            } catch (error) {
                console.error('Errore:', error);
                
                // Track generation error
                if (window.va) {
                    window.va('track', 'Generation Failed', {
                        error: error.name || 'Unknown',
                        message: error.message || 'Unknown error',
                        processingTime: Date.now() - startTime
                    });
                }
                
                let errorMessage = 'Si √® verificato un errore. Riprova pi√π tardi.';
                if (error.name === 'AbortError') {
                    errorMessage = 'Timeout - La generazione ha richiesto troppo tempo.';
                }
                
                showError(errorMessage);
                
                // Hide progress and logo, remove glowing effects
                progressContainer.classList.remove('show');
                animatedLogo.classList.remove('show');
                
                // Remove glowing effects on error
                document.getElementById('userImageContainer').classList.remove('generating');
                document.getElementById('clothingImageContainer').classList.remove('generating');
                resultContainer.classList.remove('generating');
                
                // Reset placeholder
                resultPlaceholder.style.display = 'flex';
                resultPlaceholder.innerHTML = `
                    <div class="result-icon">‚ùå</div>
                    <div>Errore durante la generazione</div>
                `;
                
            } finally {
                // Reset button and remove all glowing effects
                generateButton.disabled = false;
                generateButton.classList.remove('loading');
                generateButton.innerHTML = '<span>‚≠ê</span><span>Genera</span>';
                
                // Ensure all glowing effects are removed
                document.getElementById('userImageContainer').classList.remove('generating');
                document.getElementById('clothingImageContainer').classList.remove('generating');
                resultContainer.classList.remove('generating');
            }
        }

        function downloadImage() {
            if (!currentGeneratedImageUrl) return;
            
            // Track download event
            if (window.va) {
                window.va('track', 'Image Downloaded');
            }
            
            const link = document.createElement('a');
            link.href = currentGeneratedImageUrl;
            link.download = `cameleon-tryon-${Date.now()}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function enlargeImage() {
            if (!currentGeneratedImageUrl) return;
            
            // Track enlarge event
            if (window.va) {
                window.va('track', 'Image Enlarged');
            }
            
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            
            modalImage.src = currentGeneratedImageUrl;
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('imageModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // Initialize
        // console.log('Cameleon Virtual Try-On Ready - Gemini Powered');
        
        // Setup drag and drop functionality
        setupDragAndDrop();
        
        // Track page view
        if (window.va) {
            window.va('track', 'Page View', {
                userAgent: navigator.userAgent,
                language: navigator.language,
                screenResolution: `${screen.width}x${screen.height}`,
                version: 'gemini-powered'
            });
        }
    </script>
</body>
</html>
